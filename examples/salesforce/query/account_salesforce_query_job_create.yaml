flow:
  name: account_salesforce_query_job_create
  require_leader_election: true
  tasks:
    - generate:
        name: trigger
        interval: 1

    - salesforce_bulkapi_job_creator:
        name: create_account_query_job
        credentials_path: /etc/sfdc/credentials.json
        operation: query
        query: "SELECT Id, Name, CreatedDate, LastModifiedDate FROM Account WHERE lastmodifieddate >= {{system_info.last_run_time}}"
        content_type: CSV
        column_delimiter: COMMA
        line_ending: CRLF

    - script:
        name: check_for_errors
        code: |
          // Check if response is an error array
          if type_of(data) == "array" && !data.is_empty() {
            let first_item = data[0];
            if "errorCode" in first_item {
              // Return error for logging
              return #{
                error: true,
                errorCode: first_item.errorCode,
                message: first_item.message
              };
            }
          }

          // No error, pass through the data
          data

    - log:
        name: log_errors
        level: error
        message: "Salesforce Bulk API error: {{errorCode}} - {{message}}"
        structured: true
